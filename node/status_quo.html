<!DOCTYPE HTML>
<html lang="en" class="sidebar-visible no-js light">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>Status Quo - dives</title>
        <!-- Custom HTML head -->
        <meta content="text/html; charset=utf-8" http-equiv="Content-Type">
        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff" />

        <link rel="icon" href="../favicon.svg">
        <link rel="shortcut icon" href="../favicon.png">
        <link rel="stylesheet" href="../css/variables.css">
        <link rel="stylesheet" href="../css/general.css">
        <link rel="stylesheet" href="../css/chrome.css">
        <link rel="stylesheet" href="../css/print.css" media="print">
        <!-- Fonts -->
        <link rel="stylesheet" href="../FontAwesome/css/font-awesome.css">
        <link rel="stylesheet" href="../fonts/fonts.css">
        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" href="../highlight.css">
        <link rel="stylesheet" href="../tomorrow-night.css">
        <link rel="stylesheet" href="../ayu-highlight.css">

        <!-- Custom theme stylesheets -->
    </head>
    <body>
        <!-- Provide site root to javascript -->
        <script type="text/javascript">
            var path_to_root = "../";
            var default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? "navy" : "light";
        </script>

        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script type="text/javascript">
            try {
                var theme = localStorage.getItem('mdbook-theme');
                var sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script type="text/javascript">
            var theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { }
            if (theme === null || theme === undefined) { theme = default_theme; }
            var html = document.querySelector('html');
            html.classList.remove('no-js')
            html.classList.remove('light')
            html.classList.add(theme);
            html.classList.add('js');
        </script>

        <!-- Hide / unhide sidebar before it is displayed -->
        <script type="text/javascript">
            var html = document.querySelector('html');
            var sidebar = 'hidden';
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            }
            html.classList.remove('sidebar-visible');
            html.classList.add("sidebar-" + sidebar);
        </script>

        <nav id="sidebar" class="sidebar" aria-label="Table of contents">
            <div class="sidebar-scrollbox">
                <ol class="chapter"><li class="chapter-item expanded "><a href="../node/intro.html"><strong aria-hidden="true">1.</strong> Introduction</a></li><li class="chapter-item expanded "><a href="../node/status_quo.html" class="active"><strong aria-hidden="true">2.</strong> Status Quo</a></li><li class="chapter-item expanded "><a href="../concepts/vm_lifecycle.html"><strong aria-hidden="true">3.</strong> VM lifecycle</a></li><li class="chapter-item expanded "><a href="../concepts/cgroups.html"><strong aria-hidden="true">4.</strong> Cgroups</a></li><li class="chapter-item expanded "><a href="../concepts/namespaces.html"><strong aria-hidden="true">5.</strong> Namespaces</a></li></ol>
            </div>
            <div id="sidebar-resize-handle" class="sidebar-resize-handle"></div>
        </nav>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page">
                <div id="menu-bar-hover-placeholder"></div>
                <div id="menu-bar" class="menu-bar sticky bordered">
                    <div class="left-buttons">
                        <button id="sidebar-toggle" class="icon-button" type="button" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="sidebar">
                            <i class="fa fa-bars"></i>
                        </button>
                        <button id="theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="theme-list">
                            <i class="fa fa-paint-brush"></i>
                        </button>
                        <ul id="theme-list" class="theme-popup" aria-label="Themes" role="menu">
                            <li role="none"><button role="menuitem" class="theme" id="light">Light (default)</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="rust">Rust</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="coal">Coal</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="navy">Navy</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="ayu">Ayu</button></li>
                        </ul>
                        <button id="search-toggle" class="icon-button" type="button" title="Search. (Shortkey: s)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="S" aria-controls="searchbar">
                            <i class="fa fa-search"></i>
                        </button>
                    </div>

                    <h1 class="menu-title">dives</h1>

                    <div class="right-buttons">
                        <a href="../print.html" title="Print this book" aria-label="Print this book">
                            <i id="print-button" class="fa fa-print"></i>
                        </a>
                    </div>
                </div>

                <div id="search-wrapper" class="hidden">
                    <form id="searchbar-outer" class="searchbar-outer">
                        <input type="search" id="searchbar" name="searchbar" placeholder="Search this book ..." aria-controls="searchresults-outer" aria-describedby="searchresults-header">
                    </form>
                    <div id="searchresults-outer" class="searchresults-outer hidden">
                        <div id="searchresults-header" class="searchresults-header"></div>
                        <ul id="searchresults">
                        </ul>
                    </div>
                </div>
                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script type="text/javascript">
                    document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="content" class="content">
                    <main>
                        <h1 id="status-quo"><a class="header" href="#status-quo">Status Quo</a></h1>
<p>There are many ways to build Kubernetes clusters. 
This page covers how AKS builds Kubernetes nodes.</p>
<h2 id="overview"><a class="header" href="#overview">Overview</a></h2>
<p>A user submits a description of an AKS cluster via REST API.
The user provides configuration like VM size, Linux or Windows OS,
and other parameters. </p>
<p>AKS uses those parameters to choose a VM image. Our VM image 
doesn't contain user data, so it requires further customization on
first boot.</p>
<p>AKS takes the input from the user and passes it through functions
to generate first boot provisioning scripts for users. For Linux,
AKS applies these scripts using cloud init and Azure's custom script
extension.</p>
<p>AKS builds weekly VM images which cache as much as possible required for
all supported Kubernetes versions to reduce runtime downloads and improve
latency for users.</p>
<h2 id="goals"><a class="header" href="#goals">Goals</a></h2>
<p>We have several goals which warrant changes to this flow:</p>
<ul>
<li>We want to reduce provisioning latency for users. 
<ul>
<li>Using cloud init and CSE after VM boot adds a lot of latency.
We should strive to bake as much as possible into our VHD.</li>
</ul>
</li>
<li>We want a single source of truth for versioned components on the node (VHD).</li>
<li>We want to reduce maintenance cost of VHDs, and Agentbaker as a service.</li>
<li>We want to allow in-place update of any node configuration.</li>
</ul>
<h2 id="problems"><a class="header" href="#problems">Problems</a></h2>
<p>We have a number of issues with our current flow:</p>
<ul>
<li>CSE depends on waagent which does not start until fairly late in boot cycle.
<ul>
<li>Likely can save 5-10 seconds or more.</li>
</ul>
</li>
<li>We don't know which Kubernetes version a node will use until runtime, so we can't start kubelet earlier.
<ul>
<li>Kubelet start depends on CSE start, adding substantial latency.</li>
</ul>
</li>
<li>We do depend on data from cloud-init/cse, so we need another way to inject that earlier to the VM.
<ul>
<li>Potentially IMDS/userData</li>
</ul>
</li>
<li>CSE/cloud init as written are not known to be idempotent. This makes re-running it difficult.</li>
</ul>
<p>We also have a number of technical issues unrelated to user-facing latency:</p>
<ul>
<li>VHD build is slow (~1hr)
<ul>
<li>Lots of time spent pulling binaries/images. Can we optimize?</li>
</ul>
</li>
<li>VHD release is slow (~1d)</li>
<li>Releasing VHDs/service is still somewhat manual.</li>
<li>Cutting release branches and doing hotfixes is error prone.</li>
<li>Dependencies between code and VHD build make automatic releases difficult.</li>
</ul>
<h2 id="future"><a class="header" href="#future">Future?</a></h2>
<p>To resolve some of these, I would like to delivers:</p>
<ul>
<li>1 VHD per Kubernetes patch version, with Kubelet and all dependencies pre-installed/started.</li>
<li>Node bootstrapping dependent only on IMDS for configuration.</li>
<li>&quot;Self contained VHDs&quot; - Eliminate generation of cloud init/CSE via AgentBaker.
<ul>
<li>All scripts should be versioned and built into VHD.</li>
</ul>
</li>
<li>Node configuration daemon consuming a versioned config file.
<ul>
<li>This daemon would run on first boot and could be triggered manually for updates.</li>
</ul>
</li>
</ul>

                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->
                            <a rel="prev" href="../node/intro.html" class="mobile-nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                                <i class="fa fa-angle-left"></i>
                            </a>
                            <a rel="next" href="../concepts/vm_lifecycle.html" class="mobile-nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                                <i class="fa fa-angle-right"></i>
                            </a>
                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">
                    <a rel="prev" href="../node/intro.html" class="nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                        <i class="fa fa-angle-left"></i>
                    </a>
                    <a rel="next" href="../concepts/vm_lifecycle.html" class="nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                        <i class="fa fa-angle-right"></i>
                    </a>
            </nav>

        </div>

        <script type="text/javascript">
            window.playground_copyable = true;
        </script>
        <script src="../elasticlunr.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="../mark.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="../searcher.js" type="text/javascript" charset="utf-8"></script>
        <script src="../clipboard.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="../highlight.js" type="text/javascript" charset="utf-8"></script>
        <script src="../book.js" type="text/javascript" charset="utf-8"></script>

        <!-- Custom JS scripts -->
    </body>
</html>
