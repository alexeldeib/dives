<!DOCTYPE HTML>
<html lang="en" class="sidebar-visible no-js light">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>VM lifecycle - dives</title>
        <!-- Custom HTML head -->
        <meta content="text/html; charset=utf-8" http-equiv="Content-Type">
        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff" />

        <link rel="icon" href="../favicon.svg">
        <link rel="shortcut icon" href="../favicon.png">
        <link rel="stylesheet" href="../css/variables.css">
        <link rel="stylesheet" href="../css/general.css">
        <link rel="stylesheet" href="../css/chrome.css">
        <link rel="stylesheet" href="../css/print.css" media="print">
        <!-- Fonts -->
        <link rel="stylesheet" href="../FontAwesome/css/font-awesome.css">
        <link rel="stylesheet" href="../fonts/fonts.css">
        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" href="../highlight.css">
        <link rel="stylesheet" href="../tomorrow-night.css">
        <link rel="stylesheet" href="../ayu-highlight.css">

        <!-- Custom theme stylesheets -->
    </head>
    <body>
        <!-- Provide site root to javascript -->
        <script type="text/javascript">
            var path_to_root = "../";
            var default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? "navy" : "light";
        </script>

        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script type="text/javascript">
            try {
                var theme = localStorage.getItem('mdbook-theme');
                var sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script type="text/javascript">
            var theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { }
            if (theme === null || theme === undefined) { theme = default_theme; }
            var html = document.querySelector('html');
            html.classList.remove('no-js')
            html.classList.remove('light')
            html.classList.add(theme);
            html.classList.add('js');
        </script>

        <!-- Hide / unhide sidebar before it is displayed -->
        <script type="text/javascript">
            var html = document.querySelector('html');
            var sidebar = 'hidden';
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            }
            html.classList.remove('sidebar-visible');
            html.classList.add("sidebar-" + sidebar);
        </script>

        <nav id="sidebar" class="sidebar" aria-label="Table of contents">
            <div class="sidebar-scrollbox">
                <ol class="chapter"><li class="chapter-item expanded "><a href="../node/intro.html"><strong aria-hidden="true">1.</strong> Introduction</a></li><li class="chapter-item expanded "><a href="../node/status_quo.html"><strong aria-hidden="true">2.</strong> Status Quo</a></li><li class="chapter-item expanded "><a href="../concepts/vm_lifecycle.html" class="active"><strong aria-hidden="true">3.</strong> VM lifecycle</a></li><li class="chapter-item expanded "><a href="../concepts/cgroups.html"><strong aria-hidden="true">4.</strong> Cgroups</a></li><li class="chapter-item expanded "><a href="../concepts/namespaces.html"><strong aria-hidden="true">5.</strong> Namespaces</a></li></ol>
            </div>
            <div id="sidebar-resize-handle" class="sidebar-resize-handle"></div>
        </nav>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page">
                <div id="menu-bar-hover-placeholder"></div>
                <div id="menu-bar" class="menu-bar sticky bordered">
                    <div class="left-buttons">
                        <button id="sidebar-toggle" class="icon-button" type="button" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="sidebar">
                            <i class="fa fa-bars"></i>
                        </button>
                        <button id="theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="theme-list">
                            <i class="fa fa-paint-brush"></i>
                        </button>
                        <ul id="theme-list" class="theme-popup" aria-label="Themes" role="menu">
                            <li role="none"><button role="menuitem" class="theme" id="light">Light (default)</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="rust">Rust</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="coal">Coal</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="navy">Navy</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="ayu">Ayu</button></li>
                        </ul>
                        <button id="search-toggle" class="icon-button" type="button" title="Search. (Shortkey: s)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="S" aria-controls="searchbar">
                            <i class="fa fa-search"></i>
                        </button>
                    </div>

                    <h1 class="menu-title">dives</h1>

                    <div class="right-buttons">
                        <a href="../print.html" title="Print this book" aria-label="Print this book">
                            <i id="print-button" class="fa fa-print"></i>
                        </a>
                    </div>
                </div>

                <div id="search-wrapper" class="hidden">
                    <form id="searchbar-outer" class="searchbar-outer">
                        <input type="search" id="searchbar" name="searchbar" placeholder="Search this book ..." aria-controls="searchresults-outer" aria-describedby="searchresults-header">
                    </form>
                    <div id="searchresults-outer" class="searchresults-outer hidden">
                        <div id="searchresults-header" class="searchresults-header"></div>
                        <ul id="searchresults">
                        </ul>
                    </div>
                </div>
                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script type="text/javascript">
                    document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="content" class="content">
                    <main>
                        <h1 id="vm-lifecycle"><a class="header" href="#vm-lifecycle">VM lifecycle</a></h1>
<p>I suggest reading <a href="https://github.com/0xAX/linux-insides">linux insides</a> for a deep dive into early
Linux initialization. We most care about things happening <a href="https://github.com/0xAX/linux-insides/blob/master/Initialization/linux-initialization-10.md#first-steps-after-the-start_kernel">after
kernel</a> initialization when PID 1 starts.</p>
<h2 id="init"><a class="header" href="#init">Init</a></h2>
<p>The kernel starts /sbin/init as the first process. The init process
is responsible for early filesystem configuration and becomes the
ancestor of all new processes (for example, reaping zombies).</p>
<p>Many modern systems use systemd as init. This decision has a lot
of historical controversy. Systemd is big and complex. An init
system does not need to be. Fly.io has an open source example 
of their <a href="https://github.com/superfly/init-snapshot">init process</a>. It can be an informative example.</p>
<h2 id="systemd"><a class="header" href="#systemd">Systemd</a></h2>
<p>Systemd manages long lived services, consuming configuration in 
<a href="https://www.freedesktop.org/software/systemd/man/systemd.unit.html">unit files</a> and inferring a dependency hierarchy
from the unioned configuration of all units. </p>
<p>Systemd offers helpers to view the critical chain for any unit,
or for the entire boot cycle:</p>
<pre><code class="language-bash"> # systemd-analyze critical-chain
The time when unit became active or started is printed after the &quot;@&quot; character.
The time the unit took to start is printed after the &quot;+&quot; character.

graphical.target @20.972s
└─multi-user.target @20.972s
  └─docker.service @16.939s +4.032s
    └─network-online.target @16.910s
      └─systemd-networkd-wait-online.service @270ms +16.639s
        └─systemd-networkd.service @225ms +42ms
          └─systemd-udevd.service @197ms +27ms
            └─systemd-tmpfiles-setup-dev.service @190ms +5ms
              └─systemd-sysusers.service @184ms +5ms
                └─systemd-remount-fs.service @171ms +8ms
                  └─systemd-journald.socket @155ms
                    └─system.slice @107ms
                      └─-.slice @107ms
</code></pre>
<p>It can also output this data as an svg image viewable in a browser.</p>
<p>This data can help debug slow dependencies during VM boot.</p>
<p>Here's another example. This one was on a VM in Azure which was &quot;preprovisioned&quot;.</p>
<pre><code class="language-bash"># systemd-analyze critical-chain
The time after the unit is active or started is printed after the &quot;@&quot; character.
The time the unit takes to start is printed after the &quot;+&quot; character.


graphical.target @16min 55.434s
└─multi-user.target @16min 55.429s
  └─ephemeral-disk-warning.service @16min 55.339s +78ms
    └─cloud-config.service @16min 52.066s +3.266s
      └─basic.target @16min 51.683s
        └─sockets.target @16min 51.681s
          └─lxd.socket @16min 51.667s +6ms
            └─sysinit.target @16min 51.600s
              └─cloud-init.service @16min 44.344s +7.076s
                └─systemd-networkd-wait-online.service @16min 43.303s +1.033s
                  └─systemd-networkd.service @16min 42.924s +369ms
                    └─network-pre.target @16min 42.920s
                      └─cloud-init-local.service @2.504s +16min 40.410s
                        └─hv-kvp-daemon.service @2.500s
                          └─sys-devices-virtual-misc-vmbus\x21hv_kvp.device @2.496s
</code></pre>
<p>Notice that the VM was blocked for ~15 minutes between hv-kvp-daemon and cloud-init-local.
This is how preprovisioning works: it creates a dummy VM and then blocks early VM configuration
on a host service integration. When the block is released, the VM continues to boot and configure
normally with cloud init, overwriting the &quot;dummy&quot; configuration from the preprovisioned VM.</p>
<p>(Okay, Ace waved some hands, he doesn't 100% understand the magic.)</p>
<p>Here are a few more examples including cloud-final.service, which is the cloud init stage responsible
for writing files to disk, walinuxagent.service which runs VM extensions and reports provisioning state.</p>
<pre><code class="language-bash"># systemd-analyze critical-chain cloud-final.service
The time after the unit is active or started is printed after the &quot;@&quot; character.
The time the unit takes to start is printed after the &quot;+&quot; character.

cloud-final.service +11.703s
└─multi-user.target @33.929s
  └─ephemeral-disk-warning.service @33.896s +29ms
    └─cloud-config.service @31.392s +2.499s
      └─basic.target @31.204s
        └─paths.target @31.188s
          └─update_certs.path @31.185s
            └─sysinit.target @31.146s
              └─cloud-init.service @10.912s +20.216s
                └─cloud-init-local.service @2.528s +6.098s
                  └─systemd-remount-fs.service @1.453s +35ms
                    └─systemd-journald.socket @1.403s
                      └─system.slice @1.387s
                        └─-.slice @1.359s
</code></pre>
<pre><code class="language-bash"># systemd-analyze critical-chain walinuxagent.service
The time after the unit is active or started is printed after the &quot;@&quot; character.
The time the unit takes to start is printed after the &quot;+&quot; character.

walinuxagent.service @31.385s
└─basic.target @31.204s
  └─paths.target @31.188s
    └─update_certs.path @31.185s
      └─sysinit.target @31.146s
        └─cloud-init.service @10.912s +20.216s
          └─cloud-init-local.service @2.528s +6.098s
            └─systemd-remount-fs.service @1.453s +35ms
              └─systemd-journald.socket @1.403s
                └─system.slice @1.387s
                  └─-.slice @1.359s
</code></pre>
<h2 id="cloud-init"><a class="header" href="#cloud-init">Cloud init</a></h2>
<p><a href="https://cloudinit.readthedocs.io/en/latest/index.html">Cloud init</a> is a standard cross-distro tool for instance initialization
and first boot configuration. It has multiple <a href="https://cloudinit.readthedocs.io/en/latest/topics/boot.html">stages</a>, each with different responsibilities:</p>
<ul>
<li>Local: blocks all further boot until correct datasource/config has been applied.
Otherwise, an instance may come up with stale configuration.</li>
<li>Network: This stage processes user data, including resolving it via network, meaning it requires networking to be configured. It also runs bootcmds, and may handle disk and filesystem configuration depending on platform.</li>
<li>Config: This stage runs other configuration modules and modules which have few other dependencies, such as runcmd.</li>
<li>Final: This stage writes all late-stage user-configuration to disk, including write_files, apt packages, or user configuration on the machine.</li>
</ul>
<h2 id="observations"><a class="header" href="#observations">Observations</a></h2>
<p>Let's bring this back to Azure and Kubernetes.</p>
<p>In the <a href="../node/status_quo.html">status quo</a> doc, we summarized the high level process of node provisioning.
Now we can return to that in a bit more depth.</p>
<p>Each nodepool in each of the thousands of AKS clusters may require slightly different configuration.
Some configuration details are per-nodepool, some are per-cluster, some per Kubernetes version, etc.</p>
<p>AKS has a few tools to customize nodes:</p>
<ul>
<li>We build custom VM images. Since we don't know specific details, there are limits to what we can do here.
<ul>
<li>We can build VM images for specific scenarios to optimize e.g. latency, but this comes with maintenance cost and COGS.</li>
</ul>
</li>
<li>We can use cloud init for first boot customization of Linux nodes. This can consume cluster-specific data.
<ul>
<li>Cloud init (the agent) consumes configuration from a disk/file mounted to the VM by the Azure platform.</li>
<li>We can also read this file directly. It used to be possible to retrieve customData via IMDS but this was disabled for security reasons.</li>
</ul>
</li>
<li>We can use Azure VM extensions to configure node. Notably, the custom script extension (CSE) can deliver arbitrary bash payloads. This can also consume cluster-specific data.</li>
<li>We can use userData and retrieve the data via IMDS (yes, I just said this was disabled, but it's back!).</li>
</ul>
<p>We use custom VM images, cloud init, and CSE today.</p>
<h3 id="how-does-this-impact-latency"><a class="header" href="#how-does-this-impact-latency">How does this impact latency?</a></h3>
<p>Our VM images cache binaries and images for many Kubernetes versions,
but we do not know cluster details like Kubernetes version until runtime.
Today we rely on CSE to configure and start Kubelet. CSE itself depends on 
waagent. Waagent depends on several early cloud-init stages. If we knew
which version of kubelet we needed, we could start it as a systemd unit in
the VM image. This would likely take a dependency on network-online.target
(for connectivity to API server), but would remove any cloud init, CSE, or 
waagent dependency. In this particular case we depend on cloud-final,
which above adds 11 seconds of latency. network-online also precedes
cloud-config, removing another 3 seconds.</p>
<h3 id="summary-and-goals"><a class="header" href="#summary-and-goals">Summary and Goals</a></h3>
<p>To recap:</p>
<ul>
<li>We want to provision Kubernetes nodes as fast as possible for a good user experience.</li>
<li>We have some data we can't possibly know until the user creates a cluster.</li>
<li>We want to get that data onto a VM and process it as quickly as possible, so we can finish provisioning.</li>
</ul>
<p>Today, we do a lot of things with cloud init and CSE.
Some of these are truly necessary. Some are not.</p>
<p>To meet the goals above:</p>
<ul>
<li>We should do as much as possible in the VM image, like starting the correct version of Kubelet.</li>
<li>We should deliver runtime configuration using either customData directly from disk or userData.
<ul>
<li>We already depend on cloud init to process customData, so I suggest using userData via IMDS.</li>
<li>Additionally, userData may be changed on a live VM in VMSS without reimage, and queried via IMDS for updates.</li>
<li>This facilitates in-place update, but we need a signalling mechanism (or else we need to resort to polling).</li>
</ul>
</li>
</ul>
<p>In practice this means refactoring many of our scripts, moving things we do unnecessarily
at runtime into the VM image, and building more VM images to optimize more scenarios.</p>
<p>The in-place update point is also key. More on that later...</p>

                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->
                            <a rel="prev" href="../node/status_quo.html" class="mobile-nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                                <i class="fa fa-angle-left"></i>
                            </a>
                            <a rel="next" href="../concepts/cgroups.html" class="mobile-nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                                <i class="fa fa-angle-right"></i>
                            </a>
                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">
                    <a rel="prev" href="../node/status_quo.html" class="nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                        <i class="fa fa-angle-left"></i>
                    </a>
                    <a rel="next" href="../concepts/cgroups.html" class="nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                        <i class="fa fa-angle-right"></i>
                    </a>
            </nav>

        </div>

        <script type="text/javascript">
            window.playground_copyable = true;
        </script>
        <script src="../elasticlunr.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="../mark.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="../searcher.js" type="text/javascript" charset="utf-8"></script>
        <script src="../clipboard.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="../highlight.js" type="text/javascript" charset="utf-8"></script>
        <script src="../book.js" type="text/javascript" charset="utf-8"></script>

        <!-- Custom JS scripts -->
    </body>
</html>
